<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Force Simulation Editor</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        @import url('https://api.fontshare.com/v2/css?f[]=general-sans@400,500,600,700&f[]=cabinet-grotesk@400,500,700&display=swap');
        
        /* Using Cabinet Grotesk as Monument Grotesk alternative from Fontshare */
        @font-face {
            font-family: 'Monument';
            src: local('Cabinet Grotesk'), local('General Sans');
            font-weight: 400;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --stone-50: #fafaf9;
            --stone-200: #e7e5e4;
            --stone-300: #d6d3d1;
            --stone-400: #a8a29e;
            --stone-500: #78716c;
            --stone-700: #44403c;
            --stone-800: #292524;
            --stone-900: #1c1917;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: #d8d8d8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            cursor: pointer;
            transition: opacity 0.8s ease;
            overflow: hidden;
        }

        #loadingScreen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* Abstract organic shapes background */
        .shapes-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .organic-shape {
            position: absolute;
            background: #1a1a1a;
            border-radius: 50%;
            animation: float-organic 8s ease-in-out infinite;
        }

        /* Large irregular blob shapes */
        .shape-blob-1 {
            width: 280px;
            height: 320px;
            bottom: 5%;
            left: 5%;
            border-radius: 45% 55% 60% 40% / 50% 60% 40% 50%;
            animation: morph-blob-1 12s ease-in-out infinite;
        }

        .shape-blob-2 {
            width: 350px;
            height: 280px;
            bottom: 15%;
            left: 25%;
            border-radius: 60% 40% 50% 50% / 45% 55% 45% 55%;
            animation: morph-blob-2 15s ease-in-out infinite;
            opacity: 0.95;
        }

        .shape-blob-3 {
            width: 200px;
            height: 260px;
            top: 10%;
            left: 8%;
            border-radius: 40% 60% 55% 45% / 60% 50% 50% 40%;
            animation: morph-blob-3 10s ease-in-out infinite;
        }

        .shape-blob-4 {
            width: 240px;
            height: 200px;
            top: 25%;
            right: 10%;
            border-radius: 55% 45% 40% 60% / 50% 55% 45% 50%;
            animation: morph-blob-4 14s ease-in-out infinite;
        }

        .shape-blob-5 {
            width: 180px;
            height: 180px;
            bottom: 20%;
            right: 8%;
            border-radius: 50% 50% 45% 55% / 60% 40% 60% 40%;
            animation: morph-blob-5 11s ease-in-out infinite;
        }

        /* Small organic circles cluster */
        .shape-circles-cluster {
            position: absolute;
            top: 8%;
            left: 12%;
        }

        .small-circle {
            position: absolute;
            background: #1a1a1a;
            border-radius: 50%;
        }

        .small-circle:nth-child(1) { width: 30px; height: 30px; top: 0; left: 0; }
        .small-circle:nth-child(2) { width: 22px; height: 22px; top: 10px; left: 35px; }
        .small-circle:nth-child(3) { width: 18px; height: 18px; top: 35px; left: 15px; }
        .small-circle:nth-child(4) { width: 26px; height: 26px; top: 35px; left: 40px; }
        .small-circle:nth-child(5) { width: 16px; height: 16px; top: 55px; left: 25px; }

        /* Medium circles on the right */
        .shape-circle-1 {
            width: 120px;
            height: 120px;
            top: 8%;
            right: 12%;
            border-radius: 50%;
        }

        .shape-circle-2 {
            width: 140px;
            height: 140px;
            top: 22%;
            right: 5%;
            border-radius: 50%;
        }

        /* Dotted pattern overlays */
        .dotted-pattern {
            position: absolute;
            pointer-events: none;
        }

        .dotted-pattern::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle, #1a1a1a 2px, transparent 2px);
            background-size: 12px 12px;
        }

        .dots-1 {
            width: 150px;
            height: 120px;
            bottom: 25%;
            left: 8%;
        }

        .dots-2 {
            width: 100px;
            height: 80px;
            bottom: 32%;
            right: 15%;
        }

        .dots-3 {
            width: 80px;
            height: 60px;
            top: 45%;
            right: 22%;
        }

        /* Center content */
        .loading-content {
            text-align: center;
            padding: 2rem;
            position: relative;
            z-index: 2;
            mix-blend-mode: difference;
        }

        .loading-title {
            position: relative;
            width: clamp(400px, 75vw, 800px);
            height: clamp(300px, 50vw, 550px);
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-title svg {
            width: 100%;
            height: 100%;
            transform: rotate(-20deg);
        }

        .handwriting-stroke {
            fill: none;
            stroke: #ffffff;
            stroke-width: 10;
            stroke-linecap: round;
            stroke-linejoin: round;
            mix-blend-mode: difference;
        }

        .loading-subtitle {
            font-family: 'Cabinet Grotesk', 'General Sans', sans-serif;
            font-size: clamp(0.75rem, 2vw, 1rem);
            color: #ffffff;
            margin-bottom: 0.5rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            opacity: 0.9;
            font-weight: 400;
        }

        .loading-year {
            font-family: 'IBM Plex Mono', monospace;
            font-size: clamp(0.7rem, 1.8vw, 0.9rem);
            color: #ffffff;
            letter-spacing: 0.3em;
            margin-bottom: 2rem;
            opacity: 0.7;
        }

        .click-hint {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            color: #ffffff;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            animation: pulse 2s ease-in-out infinite;
            margin-top: 2rem;
            opacity: 0.8;
        }

        /* Corner decorations */
        .corner-text {
            position: absolute;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: #1a1a1a;
            letter-spacing: 0.08em;
            z-index: 3;
        }

        .corner-text.top-left {
            top: 2rem;
            left: 2rem;
        }

        .corner-text.top-right {
            top: 2rem;
            right: 2rem;
        }

        .corner-text.bottom-right {
            bottom: 2rem;
            right: 2rem;
            font-size: 0.65rem;
            opacity: 0.7;
        }

        /* Animations for organic shapes */
        @keyframes morph-blob-1 {
            0%, 100% { 
                border-radius: 45% 55% 60% 40% / 50% 60% 40% 50%;
                transform: rotate(0deg) scale(1);
            }
            33% { 
                border-radius: 55% 45% 50% 50% / 60% 40% 60% 40%;
                transform: rotate(5deg) scale(1.05);
            }
            66% { 
                border-radius: 50% 50% 55% 45% / 45% 55% 45% 55%;
                transform: rotate(-3deg) scale(0.98);
            }
        }

        @keyframes morph-blob-2 {
            0%, 100% { 
                border-radius: 60% 40% 50% 50% / 45% 55% 45% 55%;
                transform: translateY(0) rotate(0deg);
            }
            50% { 
                border-radius: 50% 50% 60% 40% / 55% 45% 55% 45%;
                transform: translateY(-10px) rotate(-5deg);
            }
        }

        @keyframes morph-blob-3 {
            0%, 100% { 
                border-radius: 40% 60% 55% 45% / 60% 50% 50% 40%;
                transform: scale(1) rotate(0deg);
            }
            50% { 
                border-radius: 60% 40% 45% 55% / 50% 60% 40% 50%;
                transform: scale(1.08) rotate(8deg);
            }
        }

        @keyframes morph-blob-4 {
            0%, 100% { 
                border-radius: 55% 45% 40% 60% / 50% 55% 45% 50%;
                transform: rotate(0deg);
            }
            33% { 
                border-radius: 45% 55% 60% 40% / 55% 45% 55% 45%;
                transform: rotate(-7deg);
            }
            66% { 
                border-radius: 50% 50% 50% 50% / 60% 40% 60% 40%;
                transform: rotate(4deg);
            }
        }

        @keyframes morph-blob-5 {
            0%, 100% { 
                border-radius: 50% 50% 45% 55% / 60% 40% 60% 40%;
            }
            50% { 
                border-radius: 55% 45% 55% 45% / 40% 60% 40% 60%;
            }
        }

        @keyframes float-organic {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Existing styles */
        body {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--stone-50);
            color: var(--stone-900);
            overflow: hidden;
        }

        /* Grid background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(120,113,108,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(120,113,108,0.05) 1px, transparent 1px);
            background-size: 32px 32px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* Control Panel */
        .control-panel {
            width: 320px;
            background: var(--stone-50);
            border-right: 1px solid var(--stone-300);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--stone-300);
            background: var(--stone-50);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .panel-title {
            font-family: 'Cabinet Grotesk', 'General Sans', sans-serif;
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            letter-spacing: 0.02em;
        }

        .panel-subtitle {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--stone-500);
        }

        .controls-section {
            padding: 1.5rem;
            border-bottom: 1px solid var(--stone-200);
        }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--stone-400);
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }

        .control-label-text {
            color: var(--stone-700);
        }

        .control-value {
            font-weight: 500;
            color: var(--stone-900);
            font-variant-numeric: tabular-nums;
        }

        input[type="range"] {
            width: 100%;
            height: 2px;
            background: var(--stone-300);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: var(--stone-800);
            cursor: pointer;
            border: 2px solid var(--stone-50);
            transition: all 0.15s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--stone-900);
            transform: scale(1.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--stone-800);
            cursor: pointer;
            border: 2px solid var(--stone-50);
            border-radius: 50%;
            transition: all 0.15s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: var(--stone-900);
            transform: scale(1.2);
        }

        /* Color pickers */
        .color-control {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        input[type="color"] {
            width: 40px;
            height: 40px;
            border: 1px solid var(--stone-300);
            cursor: pointer;
            background: transparent;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 0.5rem;
        }

        button {
            padding: 0.75rem 1rem;
            border: 1px solid var(--stone-300);
            background: transparent;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        button:hover {
            background: var(--stone-800);
            color: var(--stone-50);
            border-color: var(--stone-800);
        }

        button.primary {
            background: var(--stone-800);
            color: var(--stone-50);
            border-color: var(--stone-800);
        }

        button.primary:hover {
            background: var(--stone-900);
            border-color: var(--stone-900);
        }

        /* Visualization Area */
        .viz-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--stone-50);
        }

        .viz-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--stone-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .viz-title {
            font-family: 'Cabinet Grotesk', 'General Sans', sans-serif;
            font-size: 1.25rem;
            font-weight: 500;
        }

        .viz-stats {
            font-size: 0.65rem;
            color: var(--stone-500);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        #chart {
            flex: 1;
            position: relative;
        }

        #chart svg {
            width: 100%;
            height: 100%;
        }

        /* Node info tooltip */
        .node-info {
            position: absolute;
            background: var(--stone-800);
            color: var(--stone-50);
            padding: 0.5rem 0.75rem;
            font-size: 0.7rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 100;
            border: 1px solid var(--stone-700);
        }

        .node-info.visible {
            opacity: 1;
        }

        /* Toggle switches */
        .toggle-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .toggle-switch {
            width: 32px;
            height: 16px;
            background: var(--stone-300);
            border-radius: 8px;
            position: relative;
            transition: background 0.2s ease;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--stone-50);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.2s ease;
        }

        .toggle-item input[type="checkbox"] {
            display: none;
        }

        .toggle-item input[type="checkbox"]:checked + .toggle-switch {
            background: var(--stone-800);
        }

        .toggle-item input[type="checkbox"]:checked + .toggle-switch::after {
            left: 18px;
        }

        /* Preset buttons */
        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .preset-btn {
            padding: 0.75rem;
            border: 1px solid var(--stone-300);
            background: transparent;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .preset-btn:hover {
            background: var(--stone-200);
        }

        .preset-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .preset-desc {
            font-size: 0.6rem;
            color: var(--stone-500);
        }

        /* Node Editor Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--stone-50);
            border: 1px solid var(--stone-300);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--stone-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--stone-50);
            sticky: top 0;
        }

        .modal-title {
            font-family: 'Cabinet Grotesk', 'General Sans', sans-serif;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: 1px solid var(--stone-300);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--stone-400);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--stone-300);
            background: var(--stone-50);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--stone-800);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--stone-300);
            background: var(--stone-50);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .tag-input-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .tag-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--stone-300);
            background: var(--stone-50);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.875rem;
        }

        .tag-add-btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--stone-300);
            background: var(--stone-800);
            color: var(--stone-50);
            cursor: pointer;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .tags-list {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--stone-200);
            border: 1px solid var(--stone-300);
            font-size: 0.7rem;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        /* Node Types Legend */
        .node-types-legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            padding: 0.75rem;
            background: var(--stone-100);
            border-radius: 2px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.65rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--stone-800);
        }

        /* Node List */
        .node-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--stone-300);
        }

        .node-list-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .node-list-item:hover {
            background: var(--stone-100);
        }

        .node-list-item:last-child {
            border-bottom: none;
        }

        .node-list-info {
            flex: 1;
        }

        .node-list-name {
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .node-list-meta {
            font-size: 0.65rem;
            color: var(--stone-500);
        }

        .node-list-tags {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            margin-top: 0.25rem;
        }

        .node-list-tag {
            padding: 0.125rem 0.5rem;
            background: var(--stone-200);
            border: 1px solid var(--stone-300);
            font-size: 0.6rem;
        }

        .node-type-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        /* Category Manager */
        .category-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 1px solid var(--stone-300);
            background: var(--stone-50);
        }

        .category-color-picker {
            width: 32px;
            height: 32px;
            border: 1px solid var(--stone-300);
            cursor: pointer;
            flex-shrink: 0;
        }

        .category-name-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--stone-300);
            background: var(--stone-50);
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
        }

        .category-delete-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--stone-300);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .category-delete-btn:hover {
            background: var(--stone-800);
            color: var(--stone-50);
            border-color: var(--stone-800);
        }

        /* File attachments */
        .file-upload-area {
            border: 2px dashed var(--stone-300);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--stone-50);
        }

        .file-upload-area:hover {
            border-color: var(--stone-500);
            background: var(--stone-100);
        }

        .file-upload-area.dragging {
            border-color: var(--stone-800);
            background: var(--stone-200);
        }

        .file-upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.3;
        }

        .file-upload-text {
            font-size: 0.75rem;
            color: var(--stone-500);
        }

        .attached-files-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 1px solid var(--stone-300);
            background: var(--stone-50);
            transition: background 0.2s ease;
        }

        .file-item:hover {
            background: var(--stone-100);
        }

        .file-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--stone-200);
            border: 1px solid var(--stone-300);
            font-size: 0.7rem;
            font-weight: 500;
            flex-shrink: 0;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 0.65rem;
            color: var(--stone-500);
            margin-top: 0.125rem;
        }

        .file-actions {
            display: flex;
            gap: 0.25rem;
        }

        .file-action-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--stone-300);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .file-action-btn:hover {
            background: var(--stone-800);
            color: var(--stone-50);
            border-color: var(--stone-800);
        }

        .file-preview {
            max-width: 100%;
            margin-top: 0.5rem;
            border: 1px solid var(--stone-300);
        }

        input[type="file"] {
            display: none;
        }

        .node-image-preview-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--stone-300);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--stone-100);
        }

        .node-image-preview-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--stone-300);
            background: transparent;
            font-size: 0.7rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .remove-image-btn:hover {
            background: var(--stone-800);
            color: var(--stone-50);
            border-color: var(--stone-800);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <!-- Organic shapes container -->
        <div class="shapes-container">
            <!-- Large blob shapes -->
            <div class="organic-shape shape-blob-1"></div>
            <div class="organic-shape shape-blob-2"></div>
            <div class="organic-shape shape-blob-3"></div>
            <div class="organic-shape shape-blob-4"></div>
            <div class="organic-shape shape-blob-5"></div>
            
            <!-- Small circles cluster -->
            <div class="shape-circles-cluster">
                <div class="small-circle"></div>
                <div class="small-circle"></div>
                <div class="small-circle"></div>
                <div class="small-circle"></div>
                <div class="small-circle"></div>
            </div>
            
            <!-- Medium circles -->
            <div class="organic-shape shape-circle-1"></div>
            <div class="organic-shape shape-circle-2"></div>
            
            <!-- Dotted pattern overlays -->
            <div class="dotted-pattern dots-1"></div>
            <div class="dotted-pattern dots-2"></div>
            <div class="dotted-pattern dots-3"></div>
        </div>
        
        <!-- Corner text labels -->
        <div class="corner-text top-left">Graph Editor</div>
        <div class="corner-text top-right">Portfolio Resources 2025 ‚Üó</div>
        <div class="corner-text bottom-right">¬© by Malka Gadefait</div>
        
        <!-- Center content -->
        <div class="loading-content">
            <div class="loading-title">
                <svg viewBox="0 0 700 500" xmlns="http://www.w3.org/2000/svg">
                    <!-- MAKE (top line) -->
                    <!-- M -->
                    <path class="handwriting-stroke" d="M 40 200 L 45 160 L 60 100 L 75 80 L 85 120 L 95 170 L 100 200 L 105 170 L 115 120 L 130 80 L 145 100 L 155 150 L 160 200"/>
                    
                    <!-- A -->
                    <path class="handwriting-stroke" d="M 185 200 L 195 160 L 210 120 L 225 90 L 240 120 L 255 160 L 265 200"/>
                    <path class="handwriting-stroke" d="M 210 150 L 240 150"/>
                    
                    <!-- K -->
                    <path class="handwriting-stroke" d="M 290 200 L 295 160 L 305 120 L 315 90"/>
                    <path class="handwriting-stroke" d="M 305 140 L 330 110 L 345 95"/>
                    <path class="handwriting-stroke" d="M 305 140 L 330 170 L 350 200"/>
                    
                    <!-- E -->
                    <path class="handwriting-stroke" d="M 380 200 L 375 160 L 375 120 L 380 90 L 410 90"/>
                    <path class="handwriting-stroke" d="M 375 145 L 405 145"/>
                    <path class="handwriting-stroke" d="M 375 200 L 410 200"/>
                    
                    <!-- YOUR (middle line - more spaced and distinct) -->
                    <!-- Y - handwritten style with upward branches and descending tail -->
                    <path class="handwriting-stroke" d="M 30 220 L 45 235 L 65 250 L 80 260"/>
                    <path class="handwriting-stroke" d="M 125 220 L 110 235 L 90 250 L 80 260"/>
                    <path class="handwriting-stroke" d="M 80 260 L 78 280 L 75 300 L 70 320 L 65 335 L 58 345"/>
                    
                    <!-- O -->
                    <path class="handwriting-stroke" d="M 155 270 Q 145 250 145 235 Q 145 220 160 215 Q 175 210 190 220 Q 200 230 200 245 Q 200 265 190 280 Q 180 290 165 290 Q 150 290 145 275"/>
                    
                    <!-- U -->
                    <path class="handwriting-stroke" d="M 225 225 L 225 260 Q 225 280 240 290 Q 255 295 270 285 L 275 260 L 275 225"/>
                    
                    <!-- R -->
                    <path class="handwriting-stroke" d="M 300 305 L 300 260 L 305 230 L 310 220 Q 320 215 330 220 Q 340 225 340 240 Q 340 255 330 260 Q 320 265 310 260"/>
                    <path class="handwriting-stroke" d="M 310 260 L 330 285 L 345 305"/>
                    
                    <!-- GRAPH (bottom line - well separated from YOUR) -->
                    <!-- G -->
                    <path class="handwriting-stroke" d="M 100 390 Q 85 380 70 385 Q 60 390 60 405 Q 60 425 70 440 Q 80 455 100 460 Q 115 460 130 450 L 135 430"/>
                    <path class="handwriting-stroke" d="M 115 430 L 135 430"/>
                    
                    <!-- R -->
                    <path class="handwriting-stroke" d="M 155 465 L 155 420 L 160 390 L 165 380 Q 175 375 185 380 Q 195 385 195 400 Q 195 415 185 420 Q 175 425 165 420"/>
                    <path class="handwriting-stroke" d="M 165 420 L 185 445 L 200 465"/>
                    
                    <!-- A -->
                    <path class="handwriting-stroke" d="M 220 465 L 230 425 L 245 390 L 257 380 L 269 395 L 280 430 L 287 465"/>
                    <path class="handwriting-stroke" d="M 245 425 L 269 425"/>
                    
                    <!-- P -->
                    <path class="handwriting-stroke" d="M 310 505 L 310 460 L 315 420 L 320 395 Q 330 390 340 395 Q 350 400 350 415 Q 350 430 340 435 Q 330 440 320 435"/>
                    
                    <!-- H -->
                    <path class="handwriting-stroke" d="M 370 470 L 370 425 L 375 395 L 380 375"/>
                    <path class="handwriting-stroke" d="M 375 420 L 405 420"/>
                    <path class="handwriting-stroke" d="M 405 375 L 405 425 L 410 455 L 415 470"/>
                </svg>
            </div>
            <div class="click-hint">‚Üí Click to start</div>
        </div>
    </div>

    <div class="container">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="panel-header">
                <h1 class="panel-title">Force Editor</h1>
                <p class="panel-subtitle">Live Simulation Controls</p>
            </div>

            <!-- Force Controls -->
            <div class="controls-section">
                <h2 class="section-title">Forces</h2>
                
                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Link Distance</span>
                        <span class="control-value" id="linkDistanceValue">0</span>
                    </div>
                    <input type="range" id="linkDistance" min="0" max="200" value="0" step="1">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Link Strength</span>
                        <span class="control-value" id="linkStrengthValue">1.0</span>
                    </div>
                    <input type="range" id="linkStrength" min="0" max="2" value="1" step="0.1">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Charge Strength</span>
                        <span class="control-value" id="chargeStrengthValue">-50</span>
                    </div>
                    <input type="range" id="chargeStrength" min="-500" max="0" value="-50" step="10">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Center X Force</span>
                        <span class="control-value" id="centerXValue">0.0</span>
                    </div>
                    <input type="range" id="centerX" min="0" max="1" value="0" step="0.01">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Center Y Force</span>
                        <span class="control-value" id="centerYValue">0.0</span>
                    </div>
                    <input type="range" id="centerY" min="0" max="1" value="0" step="0.01">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Collision Radius</span>
                        <span class="control-value" id="collisionValue">0</span>
                    </div>
                    <input type="range" id="collision" min="0" max="50" value="0" step="1">
                </div>
            </div>

            <!-- Visual Controls -->
            <div class="controls-section">
                <h2 class="section-title">Visual</h2>
                
                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Node Radius</span>
                        <span class="control-value" id="nodeRadiusValue">3.5</span>
                    </div>
                    <input type="range" id="nodeRadius" min="1" max="20" value="3.5" step="0.5">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Link Width</span>
                        <span class="control-value" id="linkWidthValue">1.5</span>
                    </div>
                    <input type="range" id="linkWidth" min="0.5" max="5" value="1.5" step="0.5">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Link Opacity</span>
                        <span class="control-value" id="linkOpacityValue">0.6</span>
                    </div>
                    <input type="range" id="linkOpacity" min="0" max="1" value="0.6" step="0.1">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Link Color</span>
                    </div>
                    <div class="color-control">
                        <input type="color" id="linkColor" value="#999999">
                        <span id="linkColorValue" style="font-size: 0.7rem; color: var(--stone-500);">#999999</span>
                    </div>
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span class="control-label-text">Options</span>
                    </div>
                    <div class="toggle-group">
                        <label class="toggle-item">
                            <input type="checkbox" id="showLabels">
                            <span class="toggle-switch"></span>
                            <span>Labels</span>
                        </label>
                        <label class="toggle-item">
                            <input type="checkbox" id="enableDrag" checked>
                            <span class="toggle-switch"></span>
                            <span>Drag</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Presets -->
            <div class="controls-section">
                <h2 class="section-title">Presets</h2>
                <div class="preset-grid">
                    <button class="preset-btn" onclick="applyPreset('default')">
                        <div class="preset-name">Default</div>
                        <div class="preset-desc">Original setup</div>
                    </button>
                    <button class="preset-btn" onclick="applyPreset('tight')">
                        <div class="preset-name">Tight</div>
                        <div class="preset-desc">Compact cluster</div>
                    </button>
                    <button class="preset-btn" onclick="applyPreset('loose')">
                        <div class="preset-name">Loose</div>
                        <div class="preset-desc">Spread out</div>
                    </button>
                    <button class="preset-btn" onclick="applyPreset('centered')">
                        <div class="preset-name">Centered</div>
                        <div class="preset-desc">Strong gravity</div>
                    </button>
                </div>
            </div>

            <!-- Actions -->
            <div class="controls-section">
                <div class="button-group">
                    <button onclick="restartSimulation()">Restart</button>
                    <button class="primary" onclick="randomizePositions()">Randomize</button>
                </div>
            </div>

            <!-- Node Management -->
            <div class="controls-section">
                <h2 class="section-title">Node Management</h2>
                
                <div class="node-types-legend" id="categoriesLegend">
                    <!-- Will be populated dynamically -->
                </div>

                <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                    <button style="width: 100%;" onclick="openCategoryManager()">Manage Categories</button>
                    <button style="width: 100%;" onclick="openNodeManager()">Manage Nodes</button>
                </div>
            </div>
        </div>

        <!-- Visualization Area -->
        <div class="viz-area">
            <div class="viz-header">
                <h2 class="viz-title">Force-Directed Graph</h2>
                <div class="viz-stats" id="stats">
                    <span id="nodeCount">0</span> nodes ¬∑ <span id="linkCount">0</span> links
                </div>
            </div>
            <div id="chart"></div>
            <div class="node-info" id="nodeInfo"></div>
        </div>
    </div>

    <!-- Node Editor Modal -->
    <div class="modal-overlay" id="nodeEditorModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Node</h2>
                <button class="modal-close" onclick="closeNodeEditor()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="nodeTitle" placeholder="Enter node title">
                </div>

                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="nodeType">
                        <option value="default">Default</option>
                        <option value="project">Project</option>
                        <option value="concept">Concept</option>
                        <option value="material">Material</option>
                        <option value="reference">Reference</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Node Logo/Image</label>
                    <input type="file" id="nodeImageInput" accept="image/*" onchange="handleNodeImageSelect(event)">
                    <div id="nodeImagePreview" class="file-upload-area" onclick="document.getElementById('nodeImageInput').click()" 
                         style="padding: 1rem;">
                        <div class="file-upload-icon" style="margin: 0;">üñºÔ∏è</div>
                        <div class="file-upload-text">Click to upload node image</div>
                        <div class="file-upload-text" style="font-size: 0.65rem; margin-top: 0.25rem;">Will be displayed as circular logo</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Node Image / Logo</label>
                    <input type="file" id="nodeImageInput" accept="image/*" onchange="handleNodeImageSelect(event)">
                    <div class="file-upload-area" onclick="document.getElementById('nodeImageInput').click()" 
                         style="padding: 1rem;">
                        <div id="nodeImagePreview" style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                            <div class="file-upload-icon" style="margin: 0;">üñºÔ∏è</div>
                            <div class="file-upload-text">Click to upload node image</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.65rem; color: var(--stone-500);">
                        This image will be displayed as the node circle
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <div class="tag-input-container">
                        <input type="text" class="tag-input" id="tagInput" placeholder="Add a tag" onkeypress="handleTagEnter(event)">
                        <button class="tag-add-btn" onclick="addTag()">Add</button>
                    </div>
                    <div class="tags-list" id="tagsList"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Attached Files</label>
                    <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.txt,.md" onchange="handleFileSelect(event)">
                    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()" 
                         ondrop="handleFileDrop(event)" 
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        <div class="file-upload-icon">üìé</div>
                        <div class="file-upload-text">Click to upload or drag files here</div>
                        <div class="file-upload-text" style="font-size: 0.65rem; margin-top: 0.25rem;">Images, PDFs, Documents</div>
                    </div>
                    <div class="attached-files-list" id="attachedFilesList"></div>
                </div>

                <div class="button-group" style="margin-top: 2rem;">
                    <button onclick="closeNodeEditor()">Cancel</button>
                    <button class="primary" onclick="saveNode()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Manager Modal -->
    <div class="modal-overlay" id="categoryManagerModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Category Manager</h2>
                <button class="modal-close" onclick="closeCategoryManager()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Node Categories</label>
                    <div class="category-list" id="categoryList"></div>
                    <button style="width: 100%;" onclick="addNewCategory()">+ Add Category</button>
                </div>
                <div class="button-group">
                    <button onclick="closeCategoryManager()">Close</button>
                    <button class="primary" onclick="saveCategories()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Node Manager Modal -->
    <div class="modal-overlay" id="nodeManagerModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Node Manager</h2>
                <button class="modal-close" onclick="closeNodeManager()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">All Nodes (<span id="totalNodes">0</span>)</label>
                    <div class="node-list" id="nodeList"></div>
                </div>
                <div class="button-group">
                    <button onclick="closeNodeManager()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Flare dataset (simplified for performance)
        const data = {
            "name": "flare",
            "children": [
                {
                    "name": "analytics",
                    "children": [
                        { "name": "cluster", "children": [
                            {"name": "AgglomerativeCluster"}, {"name": "CommunityStructure"},
                            {"name": "HierarchicalCluster"}, {"name": "MergeEdge"}
                        ]},
                        { "name": "graph", "children": [
                            {"name": "BetweennessCentrality"}, {"name": "LinkDistance"},
                            {"name": "MaxFlowMinCut"}, {"name": "ShortestPaths"}
                        ]}
                    ]
                },
                {
                    "name": "animate",
                    "children": [
                        {"name": "Easing"}, {"name": "FunctionSequence"},
                        { "name": "interpolate", "children": [
                            {"name": "ArrayInterpolator"}, {"name": "ColorInterpolator"},
                            {"name": "DateInterpolator"}, {"name": "Interpolator"}
                        ]}
                    ]
                },
                {
                    "name": "data",
                    "children": [
                        {"name": "DataField"}, {"name": "DataSchema"}, {"name": "DataSet"}
                    ]
                },
                {
                    "name": "display",
                    "children": [
                        {"name": "DirtySprite"}, {"name": "LineSprite"}, {"name": "RectSprite"}
                    ]
                },
                {
                    "name": "physics",
                    "children": [
                        {"name": "DragForce"}, {"name": "GravityForce"}, {"name": "Spring"}
                    ]
                }
            ]
        };

        // Global variables
        let simulation, nodes, links, node, link, label, svg;
        const nodeInfo = document.getElementById('nodeInfo');
        let currentEditingNode = null;

        // Node type colors - now editable
        let nodeCategories = [
            { id: 'default', name: 'Default', color: '#292524' },
            { id: 'project', name: 'Project', color: '#2563eb' },
            { id: 'concept', name: 'Concept', color: '#dc2626' },
            { id: 'material', name: 'Material', color: '#16a34a' },
            { id: 'reference', name: 'Reference', color: '#ca8a04' }
        ];

        // Helper to get color by category id
        function getCategoryColor(categoryId) {
            const category = nodeCategories.find(c => c.id === categoryId);
            return category ? category.color : '#292524';
        }

        // Initialize node data with extended properties
        function initializeNodeData(nodes) {
            nodes.forEach(node => {
                if (!node.nodeType) node.nodeType = 'default';
                if (!node.title) node.title = node.data.name;
                if (!node.tags) node.tags = [];
                if (!node.files) node.files = [];
                if (!node.nodeImage) node.nodeImage = null;
            });
        }

        // Update categories legend
        function updateCategoriesLegend() {
            const legend = document.getElementById('categoriesLegend');
            legend.innerHTML = nodeCategories.map(cat => `
                <div class="legend-item">
                    <div class="legend-dot" style="background: ${cat.color};"></div>
                    <span>${cat.name}</span>
                </div>
            `).join('');
        }

        // Initialize
        function init() {
            const chartDiv = document.getElementById('chart');
            const width = chartDiv.clientWidth;
            const height = chartDiv.clientHeight;

            // Create hierarchy
            const root = d3.hierarchy(data);
            links = root.links();
            nodes = root.descendants();

            // Initialize extended node properties
            initializeNodeData(nodes);

            // Update categories legend
            updateCategoriesLegend();

            // Update stats
            document.getElementById('nodeCount').textContent = nodes.length;
            document.getElementById('linkCount').textContent = links.length;

            // Create SVG
            svg = d3.select("#chart")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", [-width / 2, -height / 2, width, height]);

            // Create simulation
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id))
                .force("charge", d3.forceManyBody())
                .force("x", d3.forceX())
                .force("y", d3.forceY());

            // Create links
            link = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line");

            // Create defs for circular clip paths and patterns
            const defs = svg.append("defs");

            // Create a group for nodes
            const nodeGroup = svg.append("g");

            // Create nodes with images or circles
            node = nodeGroup
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", "node-group")
                .on("mouseenter", showNodeInfo)
                .on("mouseleave", hideNodeInfo)
                .on("dblclick", editNode);

            // Add circles or images for each node
            nodes.forEach((d, i) => {
                const nodeElement = d3.select(node.nodes()[i]);
                
                if (d.nodeImage) {
                    // Create unique IDs for this node's clip and pattern
                    const clipId = `clip-${d.id || i}`;
                    const patternId = `pattern-${d.id || i}`;
                    
                    // Create circular clip path
                    defs.append("clipPath")
                        .attr("id", clipId)
                        .append("circle")
                        .attr("r", 10);
                    
                    // Create image pattern
                    const pattern = defs.append("pattern")
                        .attr("id", patternId)
                        .attr("width", 1)
                        .attr("height", 1)
                        .attr("patternContentUnits", "objectBoundingBox");
                    
                    pattern.append("image")
                        .attr("href", d.nodeImage)
                        .attr("width", 1)
                        .attr("height", 1)
                        .attr("preserveAspectRatio", "xMidYMid slice");
                    
                    // Add circle with image fill
                    nodeElement.append("circle")
                        .attr("r", 10)
                        .attr("fill", `url(#${patternId})`)
                        .attr("stroke", "#fafaf9")
                        .attr("stroke-width", 2)
                        .attr("clip-path", `url(#${clipId})`);
                } else {
                    // Regular circle with color
                    nodeElement.append("circle")
                        .attr("r", d.children ? 10 : 8)
                        .attr("fill", d.children ? "none" : getCategoryColor(d.nodeType))
                        .attr("stroke", d.children ? "#292524" : "#fafaf9")
                        .attr("stroke-width", 2);
                }
            });

            // Create labels (hidden by default)
            label = svg.append("g")
                .selectAll("text")
                .data(nodes)
                .join("text")
                .attr("font-family", "IBM Plex Mono, monospace")
                .attr("font-size", "8px")
                .attr("fill", "#292524")
                .attr("text-anchor", "middle")
                .attr("dy", "-15")
                .text(d => d.title || d.data.name)
                .style("display", "none")
                .style("pointer-events", "none");

            // Tick function
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);

                label
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });

            // Apply initial values
            updateSimulation();
            
            // Setup event listeners
            setupControls();
        }

        function setupControls() {
            // Force controls
            const controls = [
                'linkDistance', 'linkStrength', 'chargeStrength',
                'centerX', 'centerY', 'collision', 'nodeRadius',
                'linkWidth', 'linkOpacity', 'linkColor'
            ];

            controls.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', () => {
                        updateValue(id);
                        updateSimulation();
                    });
                }
            });

            // Toggle controls
            document.getElementById('showLabels').addEventListener('change', (e) => {
                label.style("display", e.target.checked ? "block" : "none");
            });

            document.getElementById('enableDrag').addEventListener('change', (e) => {
                if (e.target.checked) {
                    node.call(drag(simulation));
                } else {
                    node.on(".drag", null);
                }
            });
        }

        function updateValue(id) {
            const input = document.getElementById(id);
            const valueSpan = document.getElementById(id + 'Value');
            
            if (valueSpan) {
                let value = input.value;
                if (id === 'linkColor') {
                    valueSpan.textContent = value;
                } else {
                    valueSpan.textContent = parseFloat(value).toFixed(id.includes('Strength') || id.includes('center') || id.includes('Opacity') ? 1 : 0);
                }
            }
        }

        function updateSimulation() {
            // Get values
            const linkDistance = +document.getElementById('linkDistance').value;
            const linkStrength = +document.getElementById('linkStrength').value;
            const chargeStrength = +document.getElementById('chargeStrength').value;
            const centerX = +document.getElementById('centerX').value;
            const centerY = +document.getElementById('centerY').value;
            const collisionRadius = +document.getElementById('collision').value;
            const nodeRadius = +document.getElementById('nodeRadius').value;
            const linkWidth = +document.getElementById('linkWidth').value;
            const linkOpacity = +document.getElementById('linkOpacity').value;
            const linkColor = document.getElementById('linkColor').value;

            // Update forces
            simulation
                .force("link", d3.forceLink(links).id(d => d.id).distance(linkDistance).strength(linkStrength))
                .force("charge", d3.forceManyBody().strength(chargeStrength))
                .force("x", d3.forceX().strength(centerX))
                .force("y", d3.forceY().strength(centerY));

            if (collisionRadius > 0) {
                simulation.force("collision", d3.forceCollide().radius(collisionRadius));
            } else {
                simulation.force("collision", null);
            }

            // Update node visuals - now working with circles inside groups
            if (node) {
                node.selectAll("circle")
                    .attr("r", nodeRadius)
                    .attr("stroke-width", Math.max(1, nodeRadius / 5));
            }

            // Update link visuals
            if (link) {
                link
                    .attr("stroke", linkColor)
                    .attr("stroke-width", linkWidth)
                    .attr("stroke-opacity", linkOpacity);
            }

            // Reheat simulation
            simulation.alpha(0.3).restart();
        }

        function restartSimulation() {
            simulation.alpha(1).restart();
        }

        function randomizePositions() {
            const chartDiv = document.getElementById('chart');
            const width = chartDiv.clientWidth;
            const height = chartDiv.clientHeight;

            nodes.forEach(node => {
                node.x = (Math.random() - 0.5) * width * 0.8;
                node.y = (Math.random() - 0.5) * height * 0.8;
                node.vx = 0;
                node.vy = 0;
            });

            simulation.alpha(1).restart();
        }

        function applyPreset(preset) {
            const presets = {
                default: {
                    linkDistance: 0,
                    linkStrength: 1,
                    chargeStrength: -50,
                    centerX: 0,
                    centerY: 0,
                    collision: 0
                },
                tight: {
                    linkDistance: 20,
                    linkStrength: 1.5,
                    chargeStrength: -30,
                    centerX: 0.5,
                    centerY: 0.5,
                    collision: 10
                },
                loose: {
                    linkDistance: 100,
                    linkStrength: 0.3,
                    chargeStrength: -200,
                    centerX: 0.1,
                    centerY: 0.1,
                    collision: 20
                },
                centered: {
                    linkDistance: 50,
                    linkStrength: 0.8,
                    chargeStrength: -100,
                    centerX: 0.8,
                    centerY: 0.8,
                    collision: 5
                }
            };

            const config = presets[preset];
            if (config) {
                Object.keys(config).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = config[key];
                        updateValue(key);
                    }
                });
                updateSimulation();
            }
        }

        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        function showNodeInfo(event, d) {
            const tagsText = d.tags && d.tags.length > 0 ? ` ¬∑ ${d.tags.join(', ')}` : '';
            nodeInfo.textContent = `${d.title || d.data.name}${tagsText}`;
            nodeInfo.style.left = event.pageX + 10 + 'px';
            nodeInfo.style.top = event.pageY + 10 + 'px';
            nodeInfo.classList.add('visible');
        }

        function hideNodeInfo() {
            nodeInfo.classList.remove('visible');
        }

        // Node editing functions
        function editNode(event, d) {
            event.stopPropagation();
            currentEditingNode = d;
            
            document.getElementById('nodeTitle').value = d.title || d.data.name;
            
            // Populate type dropdown with current categories
            const typeSelect = document.getElementById('nodeType');
            typeSelect.innerHTML = nodeCategories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');
            typeSelect.value = d.nodeType || 'default';
            
            // Display current node image
            renderNodeImagePreview(d.nodeImage);
            
            // Display current tags
            renderTags(d.tags || []);
            
            // Display current files
            renderAttachedFiles(d.files || []);
            
            document.getElementById('nodeEditorModal').classList.add('visible');
        }

        function renderNodeImagePreview(imageData) {
            const preview = document.getElementById('nodeImagePreview');
            
            if (imageData) {
                preview.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                        <div class="node-image-preview-circle">
                            <img src="${imageData}" alt="Node image">
                        </div>
                        <button class="remove-image-btn" onclick="removeNodeImage()">Remove Image</button>
                    </div>
                `;
            } else {
                preview.innerHTML = `
                    <div class="file-upload-icon" style="margin: 0;">üñºÔ∏è</div>
                    <div class="file-upload-text">Click to upload node image</div>
                `;
            }
        }

        function handleNodeImageSelect(event) {
            const file = event.target.files[0];
            if (!file || !currentEditingNode) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                currentEditingNode.nodeImage = e.target.result;
                renderNodeImagePreview(currentEditingNode.nodeImage);
            };
            reader.readAsDataURL(file);
        }

        function removeNodeImage() {
            if (!currentEditingNode) return;
            currentEditingNode.nodeImage = null;
            renderNodeImagePreview(null);
        }

        function closeNodeEditor() {
            document.getElementById('nodeEditorModal').classList.remove('visible');
            currentEditingNode = null;
        }

        function saveNode() {
            if (!currentEditingNode) return;

            const title = document.getElementById('nodeTitle').value;
            const type = document.getElementById('nodeType').value;
            const tags = Array.from(document.querySelectorAll('.tag-item'))
                .map(tag => tag.textContent.replace('√ó', '').trim());

            currentEditingNode.title = title;
            currentEditingNode.nodeType = type;
            currentEditingNode.tags = tags;
            // Node image and files are already saved in currentEditingNode

            // Refresh the entire visualization to update images
            refreshVisualization();

            closeNodeEditor();
        }

        function refreshVisualization() {
            // Remove old SVG
            d3.select("#chart svg").remove();
            
            // Reinitialize
            const chartDiv = document.getElementById('chart');
            const width = chartDiv.clientWidth;
            const height = chartDiv.clientHeight;

            // Recreate SVG
            svg = d3.select("#chart")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", [-width / 2, -height / 2, width, height]);

            // Recreate simulation with existing node positions
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id))
                .force("charge", d3.forceManyBody())
                .force("x", d3.forceX())
                .force("y", d3.forceY());

            // Recreate links
            link = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line");

            // Apply current visual settings
            updateSimulation();

            // Create defs for circular clip paths and patterns
            const defs = svg.append("defs");

            // Create a group for nodes
            const nodeGroup = svg.append("g");

            // Recreate nodes with images or circles
            node = nodeGroup
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", "node-group")
                .on("mouseenter", showNodeInfo)
                .on("mouseleave", hideNodeInfo)
                .on("dblclick", editNode);

            // Add circles or images for each node
            nodes.forEach((d, i) => {
                const nodeElement = d3.select(node.nodes()[i]);
                
                if (d.nodeImage) {
                    const clipId = `clip-${d.id || i}`;
                    const patternId = `pattern-${d.id || i}`;
                    
                    defs.append("clipPath")
                        .attr("id", clipId)
                        .append("circle")
                        .attr("r", 10);
                    
                    const pattern = defs.append("pattern")
                        .attr("id", patternId)
                        .attr("width", 1)
                        .attr("height", 1)
                        .attr("patternContentUnits", "objectBoundingBox");
                    
                    pattern.append("image")
                        .attr("href", d.nodeImage)
                        .attr("width", 1)
                        .attr("height", 1)
                        .attr("preserveAspectRatio", "xMidYMid slice");
                    
                    nodeElement.append("circle")
                        .attr("r", 10)
                        .attr("fill", `url(#${patternId})`)
                        .attr("stroke", "#fafaf9")
                        .attr("stroke-width", 2)
                        .attr("clip-path", `url(#${clipId})`);
                } else {
                    nodeElement.append("circle")
                        .attr("r", d.children ? 10 : 8)
                        .attr("fill", d.children ? "none" : getCategoryColor(d.nodeType))
                        .attr("stroke", d.children ? "#292524" : "#fafaf9")
                        .attr("stroke-width", 2);
                }
            });

            // Enable drag if checkbox is checked
            if (document.getElementById('enableDrag').checked) {
                node.call(drag(simulation));
            }

            // Recreate labels
            label = svg.append("g")
                .selectAll("text")
                .data(nodes)
                .join("text")
                .attr("font-family", "IBM Plex Mono, monospace")
                .attr("font-size", "8px")
                .attr("fill", "#292524")
                .attr("text-anchor", "middle")
                .attr("dy", "-15")
                .text(d => d.title || d.data.name)
                .style("display", document.getElementById('showLabels').checked ? "block" : "none")
                .style("pointer-events", "none");

            // Tick function
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);

                label
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });

            // Restart with low heat to settle
            simulation.alpha(0.1).restart();
        }

        function addTag() {
            const input = document.getElementById('tagInput');
            const tag = input.value.trim();
            
            if (tag) {
                const currentTags = Array.from(document.querySelectorAll('.tag-item'))
                    .map(t => t.textContent.replace('√ó', '').trim());
                
                if (!currentTags.includes(tag)) {
                    currentTags.push(tag);
                    renderTags(currentTags);
                }
                
                input.value = '';
            }
        }

        function handleTagEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addTag();
            }
        }

        function renderTags(tags) {
            const container = document.getElementById('tagsList');
            container.innerHTML = tags.map(tag => `
                <div class="tag-item">
                    <span>${tag}</span>
                    <span class="tag-remove" onclick="removeTag('${tag}')">√ó</span>
                </div>
            `).join('');
        }

        function removeTag(tag) {
            const currentTags = Array.from(document.querySelectorAll('.tag-item'))
                .map(t => t.textContent.replace('√ó', '').trim())
                .filter(t => t !== tag);
            renderTags(currentTags);
        }

        // Node Manager functions
        function openNodeManager() {
            const nodeList = document.getElementById('nodeList');
            document.getElementById('totalNodes').textContent = nodes.length;
            
            nodeList.innerHTML = nodes.map(node => {
                const tagsHtml = node.tags && node.tags.length > 0 
                    ? `<div class="node-list-tags">${node.tags.map(tag => 
                        `<span class="node-list-tag">${tag}</span>`
                      ).join('')}</div>`
                    : '';
                
                const filesCount = node.files && node.files.length > 0 ? ` ¬∑ ${node.files.length} file(s)` : '';
                
                return `
                    <div class="node-list-item" onclick="editNodeById('${node.id}')">
                        <div style="display: flex; align-items: center; flex: 1;">
                            <div class="node-type-indicator" style="background: ${getCategoryColor(node.nodeType)};"></div>
                            <div class="node-list-info">
                                <div class="node-list-name">${node.title || node.data.name}</div>
                                <div class="node-list-meta">${node.nodeType || 'default'}${filesCount}</div>
                                ${tagsHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('nodeManagerModal').classList.add('visible');
        }

        function closeNodeManager() {
            document.getElementById('nodeManagerModal').classList.remove('visible');
        }

        function editNodeById(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (node) {
                closeNodeManager();
                // Simulate double click event
                editNode({ stopPropagation: () => {} }, node);
            }
        }

        // File handling functions
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFilesToCurrentNode(files);
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragging');
            
            const files = Array.from(event.dataTransfer.files);
            addFilesToCurrentNode(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('dragging');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragging');
        }

        function addFilesToCurrentNode(files) {
            if (!currentEditingNode) return;
            if (!currentEditingNode.files) currentEditingNode.files = [];

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileData = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: e.target.result,
                        id: Date.now() + Math.random()
                    };
                    currentEditingNode.files.push(fileData);
                    renderAttachedFiles(currentEditingNode.files);
                };
                reader.readAsDataURL(file);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function getFileExtension(filename) {
            return filename.split('.').pop().toUpperCase().substring(0, 3);
        }

        function renderAttachedFiles(files) {
            const container = document.getElementById('attachedFilesList');
            if (!files || files.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = files.map(file => {
                const isImage = file.type.startsWith('image/');
                return `
                    <div class="file-item">
                        <div class="file-icon">${getFileExtension(file.name)}</div>
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                        <div class="file-actions">
                            ${isImage ? `<button class="file-action-btn" onclick="previewFile('${file.id}')" title="Preview">üëÅ</button>` : ''}
                            <button class="file-action-btn" onclick="downloadFile('${file.id}')" title="Download">‚¨á</button>
                            <button class="file-action-btn" onclick="removeFile('${file.id}')" title="Remove">√ó</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function removeFile(fileId) {
            if (!currentEditingNode || !currentEditingNode.files) return;
            currentEditingNode.files = currentEditingNode.files.filter(f => f.id != fileId);
            renderAttachedFiles(currentEditingNode.files);
        }

        function downloadFile(fileId) {
            if (!currentEditingNode || !currentEditingNode.files) return;
            const file = currentEditingNode.files.find(f => f.id == fileId);
            if (!file) return;

            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            link.click();
        }

        function previewFile(fileId) {
            if (!currentEditingNode || !currentEditingNode.files) return;
            const file = currentEditingNode.files.find(f => f.id == fileId);
            if (!file || !file.type.startsWith('image/')) return;

            // Create preview modal or show in new window
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <html>
                <head><title>${file.name}</title></head>
                <body style="margin: 0; display: flex; justify-content: center; align-items: center; background: #000;">
                    <img src="${file.data}" style="max-width: 100%; max-height: 100vh;">
                </body>
                </html>
            `);
        }

        // Category Management functions
        function openCategoryManager() {
            renderCategoryList();
            document.getElementById('categoryManagerModal').classList.add('visible');
        }

        function closeCategoryManager() {
            document.getElementById('categoryManagerModal').classList.remove('visible');
        }

        function renderCategoryList() {
            const container = document.getElementById('categoryList');
            container.innerHTML = nodeCategories.map(cat => `
                <div class="category-item">
                    <input type="color" class="category-color-picker" value="${cat.color}" 
                           onchange="updateCategoryColor('${cat.id}', this.value)">
                    <input type="text" class="category-name-input" value="${cat.name}" 
                           onchange="updateCategoryName('${cat.id}', this.value)"
                           placeholder="Category name">
                    ${cat.id !== 'default' ? `
                        <button class="category-delete-btn" onclick="deleteCategory('${cat.id}')" title="Delete">√ó</button>
                    ` : '<div style="width: 32px;"></div>'}
                </div>
            `).join('');
        }

        function updateCategoryColor(id, color) {
            const category = nodeCategories.find(c => c.id === id);
            if (category) category.color = color;
        }

        function updateCategoryName(id, name) {
            const category = nodeCategories.find(c => c.id === id);
            if (category) category.name = name;
        }

        function deleteCategory(id) {
            if (id === 'default') return;
            if (confirm('Delete this category? Nodes using it will revert to default.')) {
                nodeCategories = nodeCategories.filter(c => c.id !== id);
                // Reset nodes using this category
                nodes.forEach(node => {
                    if (node.nodeType === id) node.nodeType = 'default';
                });
                renderCategoryList();
            }
        }

        function addNewCategory() {
            const id = 'cat_' + Date.now();
            nodeCategories.push({
                id: id,
                name: 'New Category',
                color: '#' + Math.floor(Math.random()*16777215).toString(16)
            });
            renderCategoryList();
        }

        function saveCategories() {
            // Update legend
            updateCategoriesLegend();
            
            // Refresh visualization to update colors
            refreshVisualization();
            
            closeCategoryManager();
        }

        // Update the showNodeInfo function
        function showNodeInfo(event, d) {
            nodeInfo.textContent = d.title || d.data.name;
            nodeInfo.style.left = event.pageX + 10 + 'px';
            nodeInfo.style.top = event.pageY + 10 + 'px';
            nodeInfo.classList.add('visible');
        }

        // Initialize on load
        window.addEventListener('load', init);

        // Loading screen handler
        document.getElementById('loadingScreen').addEventListener('click', function() {
            this.classList.add('fade-out');
            setTimeout(() => {
                this.style.display = 'none';
            }, 800);
        });

        // Handle resize
        window.addEventListener('resize', () => {
            const chartDiv = document.getElementById('chart');
            const width = chartDiv.clientWidth;
            const height = chartDiv.clientHeight;
            svg.attr("viewBox", [-width / 2, -height / 2, width, height]);
        });
    </script>
</body>
</html>